<!DOCTYPE html>
<html>
<head>
    <title>Manage RDF - Enhanced</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/extraction.css') }}">
</head>
<body>
    {% include 'components/notifications.html' %}
    
    <div align="center">
        <h1>Manage RDF</h1>
        <p class="system-status">
            <span class="status-badge">üìä Enhanced with Multi-Model Agent Integration</span>
        </p>
        <a href="{{ url_for('main.root') }}">Back to File Manager</a>
    </div>

    <div class="container">
        <div class="full-panel">
            <h2>Knowledge Graphs</h2>
            
            <!-- Agent Status Panel -->
            <div id="agentStatusPanel" class="agent-status-panel">
                <div class="status-row">
                    <strong>ü§ñ Agent Status:</strong>
                    <span id="agent-status" class="status-loading">Loading...</span>
                </div>
                <div class="status-row">
                    <strong>üìä Available Models:</strong>
                    <span id="model-status" class="status-loading">Loading...</span>
                </div>
                <div class="status-row">
                    <a href="{{ url_for('vector.vector_status') }}" class="status-link">üîç Vector DB Status</a>
                </div>
            </div>
            
            <!-- TTL Files Table -->
            <form action="{{ url_for('main.combine_ttl_files') }}" method="POST">
                <table id="ttlFilesTable" class="ttl-files-table">
                    <thead>
                        <tr>
                            <th>Select</th>
                            <th>Filename</th>
                            <th>Size</th>
                            <th>Modified</th>
                            <th>Triples</th>
                            <th>LLM Analyzed</th>
                            <th>User Modified</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in ttl_files %}
                            <tr data-filename="{{ file.filename }}">
                                <td>
                                    <input type="checkbox" name="selected_ttls" value="{{ file.filename }}">
                                </td>
                                
                                <!-- Update the filename cell to show file type: -->
                                <td class="filename-cell">
                                    <div class="filename-wrapper">
                                        <span class="filename-text">{{ file.filename }}</span>
                                        <span class="file-type-badge file-type-{{ file.get('file_type', 'TTL').lower() }}">
                                            {{ file.get('file_type', 'TTL') }}
                                        </span>
                                    </div>
                                </td>
                                
                                <td>{{ file.size }}</td>
                                <td>{{ file.modified }}</td>
                                <td>{{ file.triples }}</td>
                                
                                <!-- Enhanced LLM Analysis Status -->
                                <td class="llm-status-cell">
                                    {% set extraction_status = file.get('extraction_status', 'pending') %}
                                    {% if extraction_status == 'complete' %}
                                        <span class="status-badge status-complete">‚úÖ Complete</span>
                                        <div class="agent-details">
                                            <span class="model-info">{{ file.get('agent_model', 'Unknown') }}</span>
                                            <span class="quality-score quality-{{ file.get('quality_level', 'medium') }}">
                                                Q: {{ "%.2f"|format(file.get('quality_score', 0.0)) }}
                                            </span>
                                        </div>
                                    {% elif extraction_status == 'reviewed' %}
                                        <span class="status-badge status-reviewed">‚úÖ Reviewed</span>
                                        <div class="agent-details">
                                            <span class="stakeholder-count">{{ file.get('stakeholder_count', 0) }} stakeholders</span>
                                        </div>
                                    {% else %}
                                        <span class="status-badge status-pending">‚è≥ Pending</span>
                                    {% endif %}
                                </td>
                                
                                <!-- User Modified Status -->
                                <td class="user-status-cell">
                                    {% if file.get('user_reviewed', False) %}
                                        <span class="status-badge status-reviewed">‚úÖ Yes</span>
                                    {% else %}
                                        <span class="status-badge status-pending">‚ùå No</span>
                                    {% endif %}
                                </td>
                                
                                <!-- Action Buttons -->
                                <td class="actions-cell">
                                    <div class="action-buttons">
                                        <!-- Enhanced View Button -->
                                        {% if file.file_type == 'JSON-LD' %}
                                            <!-- JSON-LD files use your existing preview system -->
                                            <button type="button" 
                                                    class="btn btn-sm btn-secondary" 
                                                    onclick="previewJsonLdFile('{{ file.filename }}')"
                                                    title="Preview JSON-LD with tabs">
                                                üëÅÔ∏è Preview
                                            </button>
                                        {% else %}
                                            <!-- TTL files use page view -->
                                            <a href="{{ url_for('main.view_ttl_content') }}?filename={{ file.filename }}" 
                                               class="btn btn-sm btn-secondary"
                                               title="View TTL file content">
                                                üëÅÔ∏è View
                                            </a>
                                        {% endif %}
                                        
                                        <!-- Extract Button -->
                                        <button type="button" 
                                                class="btn btn-sm btn-success extraction-btn" 
                                                data-filename="{{ file.filename }}"
                                                onclick="testExtractionButton('{{ file.filename }}')"
                                                title="Extract stakeholders using AI">
                                            üìä Extract
                                        </button>
                                        
                                        <!-- Review Button (for completed extractions) -->
                                        {% if file.get('extraction_status') == 'complete' %}
                                            <button type="button" 
                                                    class="btn btn-sm btn-info review-btn" 
                                                    data-filename="{{ file.filename }}"
                                                    onclick="testReviewButton('{{ file.filename }}')"
                                                    title="Review extracted stakeholders">
                                                ‚úèÔ∏è Review
                                            </button>
                                        {% endif %}
                                        
                                        <!-- Delete Button -->
                                        <form action="{{ url_for('main.remove_ttl') }}" method="POST" style="display: inline;">
                                            <input type="hidden" name="filename" value="{{ file.filename }}">
                                            <button type="submit" 
                                                    class="btn btn-sm btn-danger"
                                                    onclick="return confirm('Are you sure you want to delete this file?')"
                                                    title="Delete this file">
                                                üóëÔ∏è Delete
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                <!-- Combine Files Section -->
                <div class="combine-section">
                    <button type="submit" class="btn btn-primary">Combine Selected Files</button>
                </div>
            </form>
            
            <!-- Action Buttons Row -->
            <div class="main-actions">
                <div class="action-group">
                    <a href="{{ url_for('main.view_combined_graph') }}">
                        <button type="button" class="btn btn-secondary">View Combined Graph</button>
                    </a>
                    <a href="{{ url_for('main.sparql_query') }}">
                        <button type="button" class="btn btn-secondary">SPARQL Query</button>
                    </a>
                    <a href="{{ url_for('main.create_test_graph') }}">
                        <button type="button" class="btn btn-secondary">Create Test Graph</button>
                    </a>
                </div>
                
                <!-- NEW: Enhanced Actions -->
                <div class="enhanced-actions">
                    <button type="button" 
                            id="bulkExtractBtn" 
                            class="btn btn-warning" 
                            onclick="handleBulkExtraction()">
                        üöÄ Bulk Extract All
                    </button>
                    <a href="#" class="btn btn-info" id="dashboardBtn">üìà Dashboard</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Extraction Modal -->
    <div id="extractionModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3>üß† Data Extraction</h3>
                <button class="modal-close" onclick="closeExtractionModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div id="extractionSetup" class="extraction-phase">
                    <div class="document-info">
                        <div class="info-row">
                            <strong>Document:</strong>
                            <span id="extractionFilename" class="filename-display">Loading...</span>
                        </div>
                        <div class="info-row">
                            <strong>Status:</strong>
                            <span id="documentStatus" class="status-display">Ready for extraction</span>
                        </div>
                    </div>
                    
                    <div class="extraction-config">
                        <div class="config-section">
                            <label class="config-label">
                                <strong>üéØ Extraction Priority:</strong>
                            </label>
                            <select id="extractionPriority" class="priority-selector">
                                <option value="cost">üí∞ Cost Optimized (Local Llama - Free)</option>
                                <option value="quality">üèÜ Quality Focused (GPT-4o - Premium)</option>
                                <option value="speed">‚ö° Speed Optimized (DeepSeek - Fast)</option>
                                <option value="privacy">üîí Privacy First (Local Only)</option>
                            </select>
                            <div class="priority-details" id="priorityDetails">
                                <span class="detail-text">Select a priority to see details</span>
                            </div>
                        </div>
                        
                        <div class="config-section">
                            <label class="config-checkbox">
                                <input type="checkbox" id="useContext" checked>
                                <span class="checkbox-label">üîç Context-Enhanced Extraction</span>
                            </label>
                            <div class="context-info">
                                Leverages similar documents for improved accuracy and context understanding
                            </div>
                        </div>
                        
                        <div class="config-section">
                            <label class="config-checkbox">
                                <input type="checkbox" id="detailedOutput" checked>
                                <span class="checkbox-label">üìä Detailed Metadata Output</span>
                            </label>
                            <div class="context-info">
                                Include confidence scores, extraction strategies, and performance metrics
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button id="startExtractionBtn" class="btn btn-primary btn-large" onclick="startExtraction()">
                            üöÄ Start Extraction
                        </button>
                        <button class="btn btn-secondary" onclick="closeExtractionModal()">
                            Cancel
                        </button>
                    </div>
                </div>
                
                <div id="extractionProgress" class="extraction-phase" style="display: none;">
                    <div class="progress-container">
                        <div class="progress-header">
                            <h4>‚è≥ Extracting Stakeholders...</h4>
                            <div class="progress-stats">
                                <span id="progressTime">00:00</span> | 
                                <span id="progressModel">Initializing...</span>
                            </div>
                        </div>
                        
                        <div class="progress-bar-container">
                            <div class="progress-bar">
                                <div id="progressBarFill" class="progress-fill"></div>
                            </div>
                            <div class="progress-percentage" id="progressPercentage">0%</div>
                        </div>
                        
                        <div class="progress-details">
                            <div id="progressText" class="progress-step">Initializing extraction agent...</div>
                            <div id="progressSubtext" class="progress-substep"></div>
                        </div>
                        
                        <div class="extraction-live-info">
                            <div class="live-info-grid">
                                <div class="info-item">
                                    <span class="info-label">Strategy:</span>
                                    <span id="liveStrategy" class="info-value">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Model:</span>
                                    <span id="liveModel" class="info-value">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Est. Cost:</span>
                                    <span id="liveCost" class="info-value">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="extractionResults" class="extraction-phase" style="display: none;">
                    <!-- Results will be populated by JavaScript -->
                </div>
                
                <div id="extractionError" class="extraction-phase error-phase" style="display: none;">
                    <div class="error-container">
                        <div class="error-header">
                            <h4>‚ùå Extraction Failed</h4>
                        </div>
                        <div class="error-content">
                            <div id="errorMessage" class="error-message"></div>
                            <div class="error-actions">
                                <button class="btn btn-warning" onclick="retryExtraction()">
                                    üîÑ Retry Extraction
                                </button>
                                <button class="btn btn-secondary" onclick="closeExtractionModal()">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Review Modal -->
    {% include 'review_modal.html' %}

    <!-- Include JavaScript files in correct order -->
    <!-- Load utility functions first -->
    <script src="{{ url_for('static', filename='js/extraction-handlers.js') }}"></script>

    <!-- Then load other modules -->
    <script src="{{ url_for('static', filename='js/extraction-core.js') }}"></script>
    <script src="{{ url_for('static', filename='js/extraction-modal.js') }}"></script>
    <script src="{{ url_for('static', filename='js/extraction-process.js') }}"></script>

    <!-- Load view functions -->
    <script src="{{ url_for('static', filename='js/view_jsonld.js') }}"></script>

    <!-- Finally load the main coordinator -->
    <script src="{{ url_for('static', filename='js/extraction.js') }}"></script>

    <script>
        // Ensure all functions are available after DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç Checking function availability:');
            console.log('getConfidenceClass:', typeof window.getConfidenceClass);
            console.log('showNotification:', typeof window.showNotification);
            console.log('openExtractionModal:', typeof window.openExtractionModal);
            console.log('previewJsonLdFile:', typeof window.previewJsonLdFile);
            
            // Test notification system
            if (typeof window.showNotification === 'function') {
                window.showNotification('‚úÖ DocEX extraction system loaded successfully!', 'success');
            }
        });
    </script>
</body>
</html>